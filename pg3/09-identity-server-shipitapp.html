<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ShipIt WebApp :: Programmeren Gevorderd 3 (BETA)</title>
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">Programmeren Gevorderd 3 (BETA)</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Producten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI</a>
                  <a class="navbar-item" target="_blank" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://desktop.github.com/download">GitHub Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://www.mysql.com/products/workbench">MySQL Workbench</a>
                  <a class="navbar-item" target="_blank" href="https://www.postman.com/downloads/">Postman</a>
                  <a class="navbar-item" target="_blank" href="https://www.jetbrains.com/rider/download">Rider</a>
                  <a class="navbar-item" target="_blank" href="https://code.visualstudio.com/download">VS Code</a>
              </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Diensten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://dev.azure.com/hogent-web4-stefancourteaux/">Azure DevOps</a>
                  <a class="navbar-item" target="_blank" href="https://portal.azure.com">Azure Portal</a>
                  <a class="navbar-item" target="_blank" href="https://chamilo.hogent.be">Chamilo</a>
                  <a class="navbar-item" target="_blank" href="https://github.com">GitHub</a>
                  <a class="navbar-item" target="_blank" href="https://jwt.io">JWT.io</a>                  
                  <a class="navbar-item" target="_blank" href="https://dotnet.microsoft.com">MS Docs</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="pg3" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Gevorderd 3</a></h3>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="0">
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="01-cloud-connected.html">Cloud Connected</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="02-microservices.html">Microservices</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="02-az-devops.html">Azure DevOps</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="03-git.html">Git Gebruik</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="05-cosmos.html">Cosmos Database</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="07-blob.html">Blob Storage</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="04-middleware.html">Middleware</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="06-pipelines.html">DevOps Pipelines</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="08-open-data-docker.html">Open Data &amp; Docker</a>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="08-02-compose.html">Dockerfiles &amp; Compose</a>
  </li>
</ul>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-auth.html">Authenticatie en Autorisatie</a>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-systemen.html">App Clients (OAuth)</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-gebruikers.html">Test Users (OIDC)</a>
  </li>
      <li class="nav-item is-active is-current-page" data-depth="2">
    <a class="nav-link" href="09-identity-server-shipitapp.html">Web App Verbinden</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-sql.html">Config in Azure SQL</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-aspnetid.html">ASP.Net Identity Users</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-sql-server-docker.html">SQL Server Docker</a>
  </li>
</ul>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="10-afronden.html">Totaalplaatje Afronden</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="99-tips.html">Tips</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="80-lesopnames-2425S2.html">Lesopnames ðŸ“º</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gevorderd 3</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Gevorderd 3</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gevorderd 3</a></li>
    <li><a href="09-auth.html">Authenticatie en Autorisatie</a></li>
    <li><a href="09-identity-server-shipitapp.html">Web App Verbinden</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">ShipIt WebApp</h1>
<div class="sect1">
<h2 id="_doel_van_deze_les"><a class="anchor" href="#_doel_van_deze_les"></a>Doel van deze les</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Een rudimentaire WebApp beveiligen met Identity Server.</p>
</li>
<li>
<p>Weten dat Razer Pages bestaan.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Front-end is geen expliciet onderdeel van dit vak. De ShipIt WebUI wordt voorzien om het groter geheel, inclusief Identity Server <em>redirects</em>, beter te illustreren. Neem geen voorbeeld aan de frontend specifieke aspecten van deze iteratie van de cursus.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_web_app_aanmaken"><a class="anchor" href="#_web_app_aanmaken"></a>Web App Aanmaken</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
De UI van Identity Server zelf is bedoeld om de login flow van een user te faciliteren. Het is niet de bedoeling in de IS web app je eigen business logica en web pagina&#8217;s toe te voegen.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We maken een nieuwe web app voor de business flows.
Deze web app zal met Identity Server spreken en dmv redirect de user naar de login pagina brengen.
Na succesvolle login zal deze terug naar de business app geleid zal worden.</p>
</div>
<div class="paragraph">
<p>De business app zal achter de schermen tegen de (beveiligde)applicatie-api spreken.</p>
</div>
<div class="paragraph">
<p>Voeg een Web App met Razor Pages toe aan de Solution.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>stefancourteaux@MBP ShipIt % pwd <i class="conum" data-value="1"></i><b>(1)</b>
/Users/stefancourteaux/Source/PG3/les08/ShipIt2425S2/ShipIt</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Print Working Directory</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>dotnet new razor -o ShipIt.WebApp</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>dotnet sln add ShipIt.WebApp</pre>
</div>
</div>
<div class="paragraph">
<p>Start de nieuwe web app eens op om te valideren dat alles correct aangemaakt werd.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/totaal/web-start.png" alt="web start">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_is_webapp_client"><a class="anchor" href="#_is_webapp_client"></a>IS WebApp Client</h2>
<div class="sectionbody">
<div class="paragraph">
<p>De nieuwe web app heeft zelf een client nodig om met IdentityServer te spreken. Voeg in IdentityServer een client toe voor deze web app.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Let er op dat je in de redirect urls het juiste poortnummer gebruikt van jouw web app. Dit kan verschillen van het voorbeeld en moet verschillen van de poort waarop IS zelf draait.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">new Client {
    ClientId = "webapp-client",
    ClientSecrets = {new Secret("eenNogGroterGeheim".Sha256())},
    AllowedGrantTypes = GrantTypes.Code,
    AllowedScopes = {
        IdentityServerConstants.StandardScopes.OpenId,
        IdentityServerConstants.StandardScopes.Profile,
    },
    RedirectUris = { "https://localhost:7164/signin-oidc" },
    PostLogoutRedirectUris = { "https://localhost:7164/signout-callback-oidc" },
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deze Client krijgt toestemming om user profile claims op te vragen. We activeren de passende scope.</p>
</div>
<div class="listingblock">
<div class="title">Config.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public static IEnumerable&lt;IdentityResource&gt; IdentityResources =&gt;
    new IdentityResource[]
    {
        new IdentityResources.OpenId(),
        new IdentityResources.Profile()
    };</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_webapp_is_connection"><a class="anchor" href="#_webapp_is_connection"></a>WebApp IS Connection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Voeg nuget package <code>Microsoft.AspNetCore.Authentication.OpenIdConnect</code> toe aan de ShipIt WebApp. Deze package, in combinatie met de nodige configuratie en net aangemaakte Client, zal de web app laten inhaken op Identity Server.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.WebApp/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">//...
builder.Services.AddAuthentication(options =&gt;
{
	options.DefaultScheme = "Cookies";
	options.DefaultChallengeScheme = "oidc"; <i class="conum" data-value="1"></i><b>(1)</b>
})
.AddCookie("Cookies")
.AddOpenIdConnect("oidc", options =&gt;
{
	options.Authority = "https://localhost:5001";

	options.ClientId = "webapp-client";
	options.ClientSecret = "eenNogGroterGeheim";
	options.ResponseType = "code";

	options.Scope.Clear();
	options.Scope.Add("openid");
	options.Scope.Add("profile");

	options.GetClaimsFromUserInfoEndpoint = true;
	options.MapInboundClaims = false;

    // access_token en id_token bijhouden
	options.SaveTokens = true;
});
//...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Controleer of de web app ingesteld is om auth af te dwingen.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.WebApp/Program.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">app.UseRouting();
app.UseAuthentication(); <i class="conum" data-value="1"></i><b>(1)</b>
app.UseAuthorization(); <i class="conum" data-value="1"></i><b>(1)</b>
app.MapRazorPages().RequireAuthorization();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>De volgorde is belangrijk.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start nu IdentityServer Ã©n de WebApp.</p>
</div>
<div class="paragraph">
<p>IdentityServer zal opstarten zoals voorheen en een overzicht tonen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/totaal/is-start.png" alt="is start">
</div>
</div>
<div class="paragraph">
<p>De WebApp zal de homepage <strong>niet</strong> tonen. Deze zal redirecten naar de login page van IS!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/totaal/app-redirect.png" alt="app redirect">
</div>
</div>
<div class="paragraph">
<p>Eenmaal ingelogd, zal IS je terugbrengen naar de web app.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/totaal/app-home.png" alt="app home">
</div>
</div>
<div class="paragraph">
<p>Merk op dat je niet opnieuw moet inloggen tussen restarts van de services. De login informatie blijft behouden in de browser.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_lezen"><a class="anchor" href="#_token_lezen"></a>Token Lezen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Op dit moment weet de web app dat we ingelogd zijn, maar ze geeft geen feedback. We hebben ook de mogelijk niet om vanuit de webapp uit te loggen - we moeten zelf expliciet naar Identity Server navigeren om dit doen.</p>
</div>
<div class="paragraph">
<p>We kunnen de relevante cookie uitlezen en de inhoud in de WebApp visualiseren.</p>
</div>
<div class="listingblock">
<div class="title">src/WebClient/Pages/Index.cshtml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;div class="text-center"&gt;
    &lt;h1 class="display-4"&gt;
        Welcome @(User.Claims.First(_ =&gt; _.Type == "name").Value)
    &lt;/h1&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-users/is-name-claim.png" alt="is name claim">
</div>
</div>
<div class="paragraph">
<p>We voorzien een Logout flow in de ShipIt Web App.</p>
</div>
<div class="paragraph">
<p>Voeg een <code>Logout.cshtml</code> pagina toe.</p>
</div>
<div class="listingblock">
<div class="title">ShipIt.WebApp/Pages/Logout.cshtml.cs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-csharp hljs" data-lang="csharp">public class LogoutModel : PageModel
{
    public IActionResult OnGet()
    {
        return SignOut("Cookies", "oidc");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>De <code>cshtml</code> mag leeg blijven gezien de <code>GET</code> direct zal redirecten.</p>
</div>
<div class="paragraph">
<p>Voeg een link naar de pagina toe in de navigatiebalk.</p>
</div>
<div class="listingblock">
<div class="title">Shared\_Layout.cshtml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;li class="nav-item"&gt;
    &lt;a class="nav-link text-dark" asp-area="" asp-page="/Logout"&gt;
        Logout
    &lt;/a&gt;
&lt;/li&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start de WebApp en IS. Log in op de WebApp als je nog niet ingelogd bent. Het logout menu-item is nu beschikbaar.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-users/wa-logout.png" alt="wa logout">
</div>
</div>
<div class="paragraph">
<p>Klik op Logout. De WebApp redirect je naar IS en deze bevestigt de logout.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/identity-server-users/wa-loggedout.png" alt="wa loggedout">
</div>
</div>
<div class="paragraph">
<p>De IS logged-out pagina geeft de mogelijkheid door te klikken naar de WebApp. "Click here to return to the webapp-client application."</p>
</div>
<div class="paragraph">
<p>Deze url werd ingesteld in de Client. Als je er op klikt, navigeer je effectief naar de WebApp. Deze zal zien dat je niet ingelogd bent en brengt je terug naar IS, maar deze keer naar het login scherm.</p>
</div>
<div class="paragraph">
<p>Eenmaal ingelogd word je terug naar de WebApp gebracht. Dit is het gewenste gedrag, zo is de authenticatie flow volledig gesloten.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oefening"><a class="anchor" href="#_oefening"></a>Oefening</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Probeer zelf de taken van deze week te implementeren. Je kan steeds kijken naar de code uit de les als je vast loopt.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a customized version of the Antora default UI.</p>
  <p>The source code for the default UI is licensed under the terms of the MPL-2.0 license.</p>
    <p>Content by Stefan Courteaux unless otherwise noted. </p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
