<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Azure DevOps Pipelines :: Programmeren Gevorderd 3 (BETA)</title>
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="#">Programmeren Gevorderd 3 (BETA)</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
      
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Producten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://learn.microsoft.com/en-us/cli/azure/">Azure CLI</a>
                  <a class="navbar-item" target="_blank" href="https://www.docker.com/products/docker-desktop">Docker Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://desktop.github.com/download">GitHub Desktop</a>
                  <a class="navbar-item" target="_blank" href="https://www.mysql.com/products/workbench">MySQL Workbench</a>
                  <a class="navbar-item" target="_blank" href="https://www.postman.com/downloads/">Postman</a>
                  <a class="navbar-item" target="_blank" href="https://www.jetbrains.com/rider/download">Rider</a>
                  <a class="navbar-item" target="_blank" href="https://code.visualstudio.com/download">VS Code</a>
              </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link" href="#">Diensten</a>
              <div class="navbar-dropdown">
                  <a class="navbar-item" target="_blank" href="https://dev.azure.com/hogent-web4-stefancourteaux/">Azure DevOps</a>
                  <a class="navbar-item" target="_blank" href="https://portal.azure.com">Azure Portal</a>
                  <a class="navbar-item" target="_blank" href="https://chamilo.hogent.be">Chamilo</a>
                  <a class="navbar-item" target="_blank" href="https://github.com">GitHub</a>
                  <a class="navbar-item" target="_blank" href="https://jwt.io">JWT.io</a>                  
                  <a class="navbar-item" target="_blank" href="https://dotnet.microsoft.com">MS Docs</a>
              </div>
          </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="pg3" data-version="">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Gevorderd 3</a></h3>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="0">
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="01-cloud-connected.html">Cloud Connected</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="02-az-devops.html">Azure DevOps</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="03-git.html">Git Gebruik</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="05-cosmos.html">Cosmos Database</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="07-blob.html">Blob Storage</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="04-middleware.html">Middleware</a>
  </li>
      <li class="nav-item is-active is-current-page" data-depth="1">
    <a class="nav-link" href="06-pipelines.html">DevOps Pipelines</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="08-open-data-docker.html">Open Data &amp; Docker</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="09-auth.html">Authenticatie en Autorisatie</a>
<ul class="nav-list">
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-systemen.html">App Clients (OAuth)</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-sql.html">Config in Azure SQL</a>
  </li>
      <li class="nav-item is-active" data-depth="2">
    <a class="nav-link" href="09-identity-server-gebruikers.html">Users (OIDC)</a>
  </li>
</ul>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="10-totaalplaatje.html">Totaalplaatje</a>
  </li>
      <li class="nav-item is-active" data-depth="1">
    <a class="nav-link" href="80-lesopnames-2425S2.html">Lesopnames ðŸ“º</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Gevorderd 3</span>
    <span class="version"></span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="index.html">Gevorderd 3</a></div>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Gevorderd 3</a></li>
    <li><a href="06-pipelines.html">DevOps Pipelines</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Azure DevOps Pipelines</h1>
<div class="sect1">
<h2 id="_doel_van_deze_les"><a class="anchor" href="#_doel_van_deze_les"></a>Doel van deze les</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Azure Pipelines leren kennen.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wat_is_een_azure_devops_pipeline"><a class="anchor" href="#_wat_is_een_azure_devops_pipeline"></a>Wat Is Een Azure DevOps Pipeline?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Een <strong>Azure DevOps Pipeline</strong> is een geautomatiseerd proces dat als overkoepelend doel heeft om efficiÃ«nter en betrouwbaarder software te bouwen en op te leveren. Het combineert drie belangrijke concepten:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Continuous Integration (CI)</strong></dt>
<dd>
<p>Codewijzigingen worden regelmatig samengevoegd. Hierdoor kunnen fouten of conflicten zo snel mogelijk worden opgespoord en opgelost.</p>
</dd>
<dt class="hdlist1"><strong>Continuous Delivery (CD)</strong></dt>
<dd>
<p>Geteste code wordt automatisch gedeployed naar verschillende omgevingen, zoals test- of productieomgevingen.</p>
</dd>
<dt class="hdlist1"><strong>Automated Testing</strong></dt>
<dd>
<p>Tests worden uitgevoerd om de kwaliteit van de code te waarborgen. Let op: de uitvoering wordt geautomatiseerd, je moet de testen zelf schrijven.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>De pipelines worden gedefinieerd in <a href="https://en.wikipedia.org/wiki/YAML">yaml</a>.</p>
</div>
<div class="paragraph">
<p>Pipelines die we bouwen worden uitgevoerd door <em>Agents</em>. Dit zijn virtuele machines. Ze kunnen door Microsoft voorzien worden, of je kan zelf virtuele machines configureren en registreren als build server.</p>
</div>
<div class="paragraph">
<p>Er zijn nagenoeg geen geldige redenen om zelf een Agent te configureren. Toch zal je zien dat sommige bedrijven zelf VM&#8217;s opzetten. Meestal is dit het gevolg van een gebrek aan kennis of van security policies die onthecht zijn van de realiteit.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Deze concepten zijn <strong>niet</strong> uniek aan Azure, er bestaat equivalente CI/CD-technologie van andere (cloud)leveranciers. De conrete voorbeelden uit de les zijn <strong>wel</strong> specifiek voor Azure.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_een_eerste_pipeline"><a class="anchor" href="#_een_eerste_pipeline"></a>Een Eerste Pipeline</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Eerst en vooral willen we de build valideren. Dit omvat:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Code uitchecken.</p>
</li>
<li>
<p>Solution builden.</p>
</li>
<li>
<p>Merge blokkeren bij gefaalde build.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">azure-pipelines.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ShipIt CI Pipeline
pool:
  vmImage: ubuntu-latest

steps:
- task: DotNetCoreCLI@2
  displayName: Build ShipIt Projects
  inputs:
    command: build
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfiguration)'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Het argument <em>buildConfiguration</em> gaan we manueel meegeven via de DevoOps website. Navigeer naar de pipeline en klik op <em>Variables</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pipelines/prvars.png" alt="prvars">
</div>
</div>
<div class="paragraph">
<p>Klik op <em>New Variable</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pipelines/prvarsnew.png" alt="prvarsnew">
</div>
</div>
<div class="paragraph">
<p>Stel juiste naam en waarde in. We zien hier de optie om een variabele <em>secret</em> te maken. Dit kunnen we gebruiken om gevoelige variabelen, die men niet zomaar mag lezen, mee te geven. We komen er later op terug.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pipelines/prvarsbuild.png" alt="prvarsbuild">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pipeline_trigger"><a class="anchor" href="#_pipeline_trigger"></a>Pipeline Trigger</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nu de pipeline beschikbaar is, willen we deze laten uitvoeren bij elke PR naar de <em>main</em> branch. Om dit te doen, maken we een policy op de main branch. De pipeline moet runnen en slagen voor elke PR naar <em>main</em>.</p>
</div>
<div class="paragraph">
<p>Project Settings &#8594; Repositories &#8594; Policies &#8594; Add &#8594; Build Validation</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pipeline_executie_impact"><a class="anchor" href="#_pipeline_executie_impact"></a>Pipeline Executie Impact</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Het resultaat van onze <em>Build Validation Policy</em> zal nu een impact hebben op de mogelijkheid om een PR te completen.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bij een <strong>positief</strong> resultaat kunnen we de PR completen.</p>
</li>
<li>
<p>Bij een <strong>negatief</strong> resultaat kunnen we de PR niet completen. De ui knop wordt ook uitgeschakeld. Een fout is snel gemaakt. Op deze manier verhinderen we dat iemand (per ongeluk) de <em>main</em> branch breekt.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pipelines/prfailure.png" alt="prfailure">
</div>
</div>
<div class="paragraph">
<p>Een build kan om meerdere redenen <em>expiren</em>. Wanneer een build als verouderd geklasseerd wordt, invalideert dit impliciet de <em>Policy</em> <strong>resultaten</strong> die ervan afhangen. Je kan vanuit het PR overzicht een nieuwe evaluatie, en dus build, triggeren.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Indien je geen rechten hebt om build agents te gebruiken, kan je bij Microsoft toestemming <a href="https://aka.ms/azpipelines-parallelism-request">aanvragen</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_automated_testing"><a class="anchor" href="#_automated_testing"></a>Automated Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We hebben er reeds voor gezorgd dat Pull Requests naar /main onze pipeline uitvoeren. Nu gaan we de <em>azure_pipelines.yaml</em> file uitbreiden om niet alleen te builden, maar ook tests uit te voeren.</p>
</div>
<div class="paragraph">
<p>Een volgende verantwoordelijkheid van de pipeline zal het automatisch uitvoeren van testen zijn.</p>
</div>
<div class="paragraph">
<p>Voeg een project toe op basis van de MSTest template. <code>ShipIt.PriceQuotes.Api.Contracts.Tests</code> is een duidelijke naam. Het nieuwe project zal een referentie naar het project <code>ShipIt.PriceQuotes.Api.Contracts</code> nodig hebben.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We verzinnen hier een test. Deze is niet al te nuttig. We hebben gewoon iets nodig om het concept te demonstreren in academische context.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ShipIt.PriceQuotes.Api.Contracts.Tests/PriceQuoteResponseContractTests.cs</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c# hljs" data-lang="c#">namespace ShipIt.PriceQuotes.Api.Contracts.Tests;

[TestClass] <i class="conum" data-value="1"></i><b>(1)</b>
public class PriceQuoteResponseContractTests <i class="conum" data-value="2"></i><b>(2)</b>
{
    [TestMethod] <i class="conum" data-value="3"></i><b>(3)</b>
    public void GivenCompleteContract_WhenUpdatingPrice_ThenPriceIsChanged() <i class="conum" data-value="4"></i><b>(4)</b>
    {
        // arrange
        var contract = new PriceQuoteResponseContract{
            Id = Guid.NewGuid().ToString(),
            PriceEuro = 2,
            ValidUntil = DateTime.Now
        };

        // act
        contract.PriceEuro = 3;

        // assert
        Assert.AreEqual(3, contract.PriceEuro);

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Zorgt ervoor dat de klasse opgepikt wordt door MSTest Runner.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Naam van de test klasse. Beschrijft welke klasse we testen.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Zorgt ervoor dat de methode opgepikt wordt door MSTest Runner.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Naam van de test. Gebruikt <a href="https://martinfowler.com/bliki/GivenWhenThen.html">Given-When-Then</a> patroon.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>De logica in de test volgt het <a href="https://automationpanda.com/2020/07/07/arrange-act-assert-a-pattern-for-writing-good-tests/">Arrange-Act-Assert</a> patroon.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pipelines/tests.png" alt="tests">
</div>
</div>
<div class="paragraph">
<p>Nu gaan we de pipeline aanpassen om de tests uit te voeren.</p>
</div>
<div class="listingblock">
<div class="title">azure-pipelines.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># ShipIt CI Pipeline
pool:
  vmImage: ubuntu-latest

steps:
- task: DotNetCoreCLI@2
  displayName: Build ShipIt Projects
  inputs:
    command: build
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfiguration)'

- task: DotNetCoreCLI@2 <i class="conum" data-value="1"></i><b>(1)</b>
  displayName: Test ShipIt Projects
  inputs:
    command: test
    projects: '**/*Tests/*.csproj' <i class="conum" data-value="2"></i><b>(2)</b>
    arguments: '--configuration $(buildConfiguration)'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We voegen een tweede task toe.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>De project filter is restrictiever dan die van de build task. We willen nu enkel de projecten,en hun dependencies, in scope brengen die tests bevatten. Het is best practice om dit duidelijk te maken adhv de project naam.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Wanneer deze pipeline uitgevoerd wordt, zal deze testresultaten publiceren.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/pipelines/testres.png" alt="testres">
</div>
</div>
<div class="paragraph">
<p>Een PR triggert nu build + tests. De PR kan alleen gecomplete worden wanneer alles er goed uitziet. Daarmee is het Continuous Integration luik rond.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
De volgende stap in het CI/CD verhaal, is Deployment. We hebben tot op heden manueel naar Azure gedeployed. Idealiter zouden we dit automatiseren, maar er zijn restricties van toepassing op de Azure voor studenten die ons verhinderen dit verder uit te diepen.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_oefening"><a class="anchor" href="#_oefening"></a>Oefening</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Probeer zelf de taak van de week te implementeren. Je kan steeds kijken naar de code uit de les als je vast loopt.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_referenties"><a class="anchor" href="#_referenties"></a>Referenties</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://learn.microsoft.com/en-us/azure/devops/pipelines/?view=azure-devops">Pipelines</a></p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a customized version of the Antora default UI.</p>
  <p>The source code for the default UI is licensed under the terms of the MPL-2.0 license.</p>
    <p>Content by Stefan Courteaux unless otherwise noted. </p>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
